<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGFlix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #181a1b;
        }

        .tmdb-tile {
            background: #23272b;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 1.5rem;
            transition: transform 0.1s;
        }

        .tmdb-tile:hover {
            transform: scale(1.03);
        }

        .tmdb-poster {
            width: 100%;
            border-radius: 12px 12px 0 0;
            object-fit: cover;
            height: auto;
            background: #343a40;
        }

        .tmdb-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .vote-badge {
            background: #ffc107;
            color: #23272b;
            font-weight: 700;
        }

        .file-list {
            background: #181a1b;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .file-link {
            word-break: break-all;
        }

        .file-name {
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h2 class="mb-4 text-center text-light">TGFlix</h2>
        <form id="searchForm" class="mb-4 d-flex justify-content-center">
            <input type="text" id="searchInput" class="form-control w-50 me-2" placeholder="Search ..." />
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <div id="tiles" class="row g-3"></div>
        <nav>
            <ul class="pagination justify-content-center mt-4">
                <li class="page-item"><button class="page-link" id="prevBtn">Previous</button></li>
                <li class="page-item"><span class="page-link" id="pageNum">1</span></li>
                <li class="page-item"><button class="page-link" id="nextBtn">Next</button></li>
            </ul>
        </nav>
    </div>
    <!-- Modal for file details -->
    <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileModalLabel">Files</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="fileModalBody">
                    <!-- File details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BASE_URL = ""; // Set your API base URL here

        let page = 1;
        let currentQuery = '';
        const tiles = document.getElementById('tiles');
        const pageNum = document.getElementById('pageNum');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const fileModal = new bootstrap.Modal(document.getElementById('fileModal'));
        const fileModalBody = document.getElementById('fileModalBody');

        async function loadTiles() {
            tiles.innerHTML = '<div class="text-center text-light">Loading...</div>';
            let url = '';
            if (currentQuery) {
                url = `${BASE_URL}/files/search/?query=${encodeURIComponent(currentQuery)}&page=${page}`;
            } else {
                url = `${BASE_URL}/tmdb/all/?page=${page}`;
            }
            try {
                const res = await fetch(url);
                const data = await res.json();
                tiles.innerHTML = '';
                if (data.results.length === 0) {
                    tiles.innerHTML = '<div class="text-center text-light">No results found.</div>';
                }
                data.results.forEach(item => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-sm-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                    <div class="tmdb-tile h-100 d-flex flex-column">
                        <img src="${item.poster_url || 'https://via.placeholder.com/500x750?text=No+Image'}" class="tmdb-poster" alt="Poster">
                        <div class="p-3 flex-grow-1 d-flex flex-column">
                            <div class="tmdb-title mb-2">${item.title || 'No Title'}</div>
                            <div class="mb-2">
                                ${(item.vote_average && item.vote_average !== 0)
                            ? `<span class="badge vote-badge">⭐ ${Number(item.vote_average).toFixed(1)}</span>`
                            : ''
                        }
                            </div>
                            <div class="text-secondary small mb-2">${item.tmdb_type?.toUpperCase() || ''} | ${item.tmdb_id || ''}</div>
                            <button class="btn btn-outline-info btn-sm mt-auto view-files-btn" data-tmdb-id="${item.tmdb_id}" data-tmdb-type="${item.tmdb_type}">
                                View
                            </button>
                        </div>
                    </div>
                `;
                    tiles.appendChild(col);
                });
                pageNum.textContent = page;
                prevBtn.disabled = page <= 1;
                nextBtn.disabled = (page * 10) >= data.total;

                // Add event listeners for all view buttons
                document.querySelectorAll('.view-files-btn').forEach(btn => {
                    btn.onclick = async function () {
                        const tmdbId = btn.getAttribute('data-tmdb-id');
                        const tmdbType = btn.getAttribute('data-tmdb-type');
                        await showFilesModal(tmdbId, tmdbType);
                    };
                });
            } catch (e) {
                tiles.innerHTML = '<div class="text-danger text-center">Failed to load data.</div>';
            }
        }

        async function showFilesModal(tmdbId, tmdbType) {
            fileModalBody.innerHTML = '<div class="text-center">Loading files...</div>';
            try {
                const res = await fetch(`${BASE_URL}/files/by_tmdb/?tmdb_id=${tmdbId}&tmdb_type=${tmdbType}`);
                if (!res.ok) throw new Error();
                const data = await res.json();

                let tmdbInfoHtml = '';
                if (data.tmdb_info) {
                    tmdbInfoHtml = `
            <div class="mb-3">
                <div class="d-flex align-items-start">
                    <img src="${data.tmdb_info.poster_url || 'https://via.placeholder.com/150x225?text=No+Image'}" alt="Poster" style="width:100px; border-radius:8px; margin-right:16px;">
                    <div>
                        <h5>${data.tmdb_info.title || ''}</h5>
                        <div class="text-secondary small mb-1">${data.tmdb_info.release_date || ''}</div>
                        <div class="mb-1">
                            ${(data.tmdb_info.vote_average && data.tmdb_info.vote_average !== "0.0")
                            ? `<span class="badge vote-badge">⭐ ${data.tmdb_info.vote_average}</span>`
                            : ''
                        }
                        </div>
                        <div class="mb-2">${data.tmdb_info.overview || ''}</div>
                        ${data.tmdb_info.trailer_url
                            ? `<a href="${data.tmdb_info.trailer_url}" target="_blank" class="btn btn-sm btn-danger">Watch Trailer</a>`
                            : ''
                        }
                    </div>
                </div>
            </div>
            <hr class="bg-secondary">
        `;
                }

                if (!data.results.length) {
                    fileModalBody.innerHTML = tmdbInfoHtml + '<div class="text-center text-light">No files found for this title.</div>';
                } else {
                    fileModalBody.innerHTML = tmdbInfoHtml + `
            <div class="file-list">
                <ul class="list-group list-group-flush">
                    ${data.results.map(f => `
                        <li class="list-group-item bg-dark text-light">
                            <div class="file-name"><strong>${f.file_name}</strong></div>
                            <div class="small">Size: ${f.file_size ? humanFileSize(f.file_size) : 'N/A'}</div>
                            <a href="${f.link}" class="btn btn-success btn-sm file-link" target="_blank">Send</a>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
                }
            } catch {
                fileModalBody.innerHTML = '<div class="text-danger text-center">Failed to load files.</div>';
            }
            fileModal.show();
        }
        function humanFileSize(bytes) {
            if (!bytes) return 'N/A';
            const thresh = 1024;
            if (Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }
            const units = ['KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            let u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while (Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1) + ' ' + units[u];
        }

        prevBtn.onclick = () => { if (page > 1) { page--; loadTiles(); } };
        nextBtn.onclick = () => { page++; loadTiles(); };

        searchForm.onsubmit = (e) => {
            e.preventDefault();
            page = 1;
            currentQuery = searchInput.value.trim();
            loadTiles();
        };

        loadTiles();
    </script>
</body>

</html>